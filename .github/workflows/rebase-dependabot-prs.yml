name: Rebase Dependabot PRs

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  pull-requests: write
  issues: write

jobs:
  rebase-dependabot-prs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Comment on Dependabot PRs to trigger rebase
        uses: actions/github-script@v7
        with:
          script: |
            const dependabotPRs = [
              222,  // org.apache.commons:commons-csv from 1.7 to 1.14.1
              223,  // com.oracle.database.xml:xmlparserv2
              224,  // version.testContainers from 1.21.3 to 1.21.4 (contains the fix!)
              225,  // com.google.code.gson:gson from 2.8.9 to 2.13.2
              226,  // org.postgresql:postgresql from 42.7.2 to 42.7.9
              227,  // actions/upload-artifact from 4 to 6
              228,  // docker/setup-qemu-action from 1 to 3
              229,  // docker/login-action from 1 to 3
              230,  // rake requirement from ~> 10.0 to ~> 13.3 in /docs
              231,  // docker/setup-buildx-action from 1 to 3
              232,  // actions/setup-java from 4 to 5
              233,  // jekyll requirement from ~> 3.3 to >= 3.3, < 5.0 in /docs
            ];
            
            const commentBody = '@dependabot rebase';
            
            console.log('Starting to comment on Dependabot PRs...');
            console.log('Total PRs to process:', dependabotPRs.length);
            
            for (const prNumber of dependabotPRs) {
              try {
                // Check if PR is still open
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                
                if (pr.state !== 'open') {
                  console.log(`Skipping PR #${prNumber} - already ${pr.state}`);
                  continue;
                }
                
                // Check if it's from Dependabot
                if (pr.user.login !== 'dependabot[bot]') {
                  console.log(`Skipping PR #${prNumber} - not from Dependabot`);
                  continue;
                }
                
                // Create comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: commentBody
                });
                
                console.log(`✅ Successfully commented on PR #${prNumber}: ${pr.title}`);
                
                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 1000));
                
              } catch (error) {
                console.error(`❌ Failed to comment on PR #${prNumber}:`, error.message);
              }
            }
            
            console.log('Done! All Dependabot PRs have been processed.');
            
      - name: Summary
        run: |
          echo "### Dependabot Rebase Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commented '@dependabot rebase' on all open Dependabot PRs." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Why this is needed:**" >> $GITHUB_STEP_SUMMARY
          echo "Dependabot PRs are failing due to TestContainers/Docker API incompatibility." >> $GITHUB_STEP_SUMMARY
          echo "Rebasing will pick up the TestContainers 1.21.4 fix from master." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor CI runs - they should now pass" >> $GITHUB_STEP_SUMMARY
          echo "2. Auto-merge workflow will merge PRs once CI passes" >> $GITHUB_STEP_SUMMARY
          echo "3. See .github/workflows/INVESTIGATION-SUMMARY.md for details" >> $GITHUB_STEP_SUMMARY
